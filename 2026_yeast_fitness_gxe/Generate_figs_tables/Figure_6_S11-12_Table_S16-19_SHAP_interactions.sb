#!/bin/bash --login
#SBATCH --time=4:00:00
#SBATCH --nodes=1
#SBATCH --ntasks=2
# SBATCH --cpus-per-task=12 # for RF models
# SBATCH --mem-per-cpu=3G # for RF models
# SBATCH --job-name ben_rf_individual
# SBATCH --job-name ben_rf_integrated
#SBATCH --cpus-per-task=4 # for shap interaction
#SBATCH --mem-per-cpu=100G # for shap interaction
#SBATCH --job-name shap_interaction
#SBATCH --output=/mnt/research/glbrc_group/shiulab/kenia/yeast_project/SHAP_Interaction/benomyl_shap_int_rf/logs/%x_%j.out

shap=/mnt/research/glbrc_group/shiulab/kenia/Shiu_Lab/Project/Scripts/Data_Vis
data=/mnt/research/glbrc_group/shiulab/kenia/Shiu_Lab/Project/Data/Peter_2018
pipe=/mnt/research/glbrc_group/shiulab/kenia/Shiu_Lab/Project/External_software/ML-Pipeline

####################### Benomyl Benchmark Gene RF Models #######################
module purge
conda activate ml-pipeline

cd /mnt/research/glbrc_group/shiulab/kenia/yeast_project/SHAP_Interaction/benomyl_shap_int_rf

# SNP
python ${pipe}/ML_regression.py -df ${data}/geno_corrected.csv \
   -df2 ${data}/pheno.csv -sep , \
   -y_name YPDBENOMYL500 \
   -test ${data}/Test.txt \
   -feat Features_one_variant_per_gene_benomyl_500ugml_snp.txt \
   -alg RF -n_jobs 12 -n 20 -cv_num 5 -plots f \
   -tag snp_one_variant_per_gene_benomyl_500ugml \
   -save snp_one_variant_per_gene_benomyl_500ugml

# PAV
python ${pipe}/ML_regression.py -df ${data}/ORFs_pres_abs.csv \
   -df2 ${data}/pheno.csv -sep , \
   -y_name YPDBENOMYL500 \
   -test ${data}/Test.txt \
   -feat Features_one_variant_per_gene_benomyl_500ugml_pav_fixed.txt \
   -alg RF -n_jobs 12 -n 20 -cv_num 5 -plots f \
   -tag pav_one_variant_per_gene_benomyl_500ugml \
   -save pav_one_variant_per_gene_benomyl_500ugml

# CNV
python ${pipe}/ML_regression.py -df ${data}/ORFs_no_NA.csv \
   -df2 ${data}/pheno.csv -sep , \
   -y_name YPDBENOMYL500 \
   -test ${data}/Test.txt \
   -feat Features_one_variant_per_gene_benomyl_500ugml_cnv_fixed.txt \
   -alg RF -n_jobs 12 -n 20 -cv_num 5 -plots f \
   -tag cnv_one_variant_per_gene_benomyl_500ugml \
   -save cnv_one_variant_per_gene_benomyl_500ugml

# SNP + PAV + CNV
python ${pipe}/ML_regression.py \
	-df Features_one_variant_per_gene_benomyl_500ugml_snp_pav_cnv.txt \
	-df2 ${data}/pheno.csv -sep , \
	-y_name YPDBENOMYL500 \
	-test ${data}/Test.txt \
	-alg RF -n_jobs 12 -n 20 -cv_num 5 -plots f \
	-tag integrated_one_variant_per_gene_benomyl_500ugml \
	-save integrated_one_variant_per_gene_benomyl_500ugml

# SNP + PAV
python ${pipe}/ML_regression.py \
	-df Features_one_variant_per_gene_benomyl_500ugml_snp_pav.txt \
	-df2 ${data}/pheno.csv -sep , \
	-y_name YPDBENOMYL500 \
	-test ${data}/Test.txt \
	-alg RF -n_jobs 12 -n 20 -cv_num 5 -plots f \
	-tag integrated_snp_pav_one_variant_per_gene_benomyl_500ugml \
	-save integrated_snp_pav_one_variant_per_gene_benomyl_500ugml

# SNP + CNV
python ${pipe}/ML_regression.py \
	-df Features_one_variant_per_gene_benomyl_500ugml_snp_cnv.txt \
	-df2 ${data}/pheno.csv -sep , \
	-y_name YPDBENOMYL500 \
	-test ${data}/Test.txt \
	-alg RF -n_jobs 12 -n 20 -cv_num 5 -plots f \
	-tag integrated_snp_cnv_one_variant_per_gene_benomyl_500ugml \
	-save integrated_snp_cnv_one_variant_per_gene_benomyl_500ugml

# PAV + CNV
python ${pipe}/ML_regression.py \
	-df Features_one_variant_per_gene_benomyl_500ugml_pav_cnv.txt \
	-df2 ${data}/pheno.csv -sep , \
	-y_name YPDBENOMYL500 \
	-test ${data}/Test.txt \
	-alg RF -n_jobs 12 -n 20 -cv_num 5 -plots f \
	-tag integrated_pav_cnv_one_variant_per_gene_benomyl_500ugml \
	-save integrated_pav_cnv_one_variant_per_gene_benomyl_500ugml

conda deactivate

############################ Benomyl SHAP Interaction Scores ###########################
module purge
conda activate shap

cd /mnt/research/glbrc_group/shiulab/kenia/yeast_project/SHAP_Interaction/benomyl_shap_int_rf

mapfile -t models < best_benomyl_models.txt

# Calculate SHAP interaction scores
# SNP model
cd snp
python ${shap}/SHAP_training_saving_interaction.py \
	-df ${data}/geno_corrected.csv \
	-df2 ${data}/pheno.csv -sep , \
	-y_name YPDBENOMYL500 \
	-test ${data}/Test.txt \
	-feat ../Features_one_variant_per_gene_benomyl_500ugml_snp.txt \
	-model ../${models[0]} \
	-top 20 -interaction n -interaction_score y \
	-save snp_one_variant_per_gene_benomyl_500ugml

echo "Summing SHAP values across isolates for SNP"
python ${shap}/Sum_SHAP_interaction.py \
	-path /mnt/research/glbrc_group/shiulab/kenia/yeast_project/SHAP_Interaction/benomyl_shap_int_rf/snp/ \
	-dtype snp \
	-save shap_interaction_scores_snp_one_variant_per_gene_benomyl_500ugml

## PAV model
cd pav
python ${shap}/SHAP_training_saving_interaction.py \
	-df ${data}/ORFs_pres_abs.csv \
	-df2 ${data}/pheno.csv -sep , \
	-y_name YPDBENOMYL500 \
	-test ${data}/Test.txt \
	-feat ../Features_one_variant_per_gene_benomyl_500ugml_pav_fixed.txt \
	-model ../${models[1]} \
	-top 20 -interaction n -interaction_score y \
	-save pav_one_variant_per_gene_benomyl_500ugml

echo "Summing SHAP values across isolates for PAV"
python ${shap}/Sum_SHAP_interaction.py \
	-path /mnt/research/glbrc_group/shiulab/kenia/yeast_project/SHAP_Interaction/benomyl_shap_int_rf/pav/ \
	-dtype pav \
	-save shap_interaction_scores_pav_one_variant_per_gene_benomyl_500ugml

## CNV model
cd cnv
python ${shap}/SHAP_training_saving_interaction.py \
	-df ${data}/ORFs_no_NA.csv \
	-df2 ${data}/pheno.csv -sep , \
	-y_name YPDBENOMYL500 \
	-test ${data}/Test.txt \
	-feat ../Features_one_variant_per_gene_benomyl_500ugml_cnv_fixed.txt \
	-model ../${models[2]} \
	-top 20 -interaction n -interaction_score y \
	-save cnv_one_variant_per_gene_benomyl_500ugml

echo "Summing SHAP values across isolates for CNV"
python ${shap}/Sum_SHAP_interaction.py \
	-path /mnt/research/glbrc_group/shiulab/kenia/yeast_project/SHAP_Interaction/benomyl_shap_int_rf/cnv/ \
	-dtype cnv \
	-save shap_interaction_scores_cnv_one_variant_per_gene_benomyl_500ugml

## Integrated models
cd snp_pav_cnv
python ${shap}/SHAP_training_saving_interaction.py \
	-df ../Features_one_variant_per_gene_benomyl_500ugml_snp_pav_cnv.txt \
	-df2 ${data}/pheno.csv -sep , \
	-y_name YPDBENOMYL500 \
	-test ${data}/Test.txt \
	-model ../${models[3]} \
	-top 20 -interaction n -interaction_score y \
	-save integrated_snp_pav_cnv_one_variant_per_gene_benomyl_500ugml

echo "Summing SHAP values across isolates for integrated model"
python ${shap}/Sum_SHAP_interaction.py \
	-path /mnt/research/glbrc_group/shiulab/kenia/yeast_project/SHAP_Interaction/benomyl_shap_int_rf/snp_pav_cnv/ \
	-dtype integrated_snp_pav_cnv \
	-save shap_interaction_scores_integrated_snp_pav_cnv_one_variant_per_gene_benomyl_500ugml

cd snp_pav
python ${shap}/SHAP_training_saving_interaction.py \
	-df ../Features_one_variant_per_gene_benomyl_500ugml_snp_pav.txt \
	-df2 ${data}/pheno.csv -sep , \
	-y_name YPDBENOMYL500 \
	-test ${data}/Test.txt \
	-model ../${models[4]} \
	-top 20 -interaction n -interaction_score y \
	-save integrated_snp_pav_one_variant_per_gene_benomyl_500ugml

echo "Summing SHAP values across isolates for integrated model"
python ${shap}/Sum_SHAP_interaction.py \
	-path /mnt/research/glbrc_group/shiulab/kenia/yeast_project/SHAP_Interaction/benomyl_shap_int_rf/snp_pav/ \
	-dtype integrated_snp_pav \
	-save shap_interaction_scores_integrated_snp_pav_one_variant_per_gene_benomyl_500ugml

cd snp_cnv
python ${shap}/SHAP_training_saving_interaction.py \
	-df ../Features_one_variant_per_gene_benomyl_500ugml_snp_cnv.txt \
	-df2 ${data}/pheno.csv -sep , \
	-y_name YPDBENOMYL500 \
	-test ${data}/Test.txt \
	-model ../${models[5]} \
	-top 20 -interaction n -interaction_score y \
	-save integrated_snp_cnv_one_variant_per_gene_benomyl_500ugml

echo "Summing SHAP values across isolates for integrated model"
python ${shap}/Sum_SHAP_interaction.py \
	-path /mnt/research/glbrc_group/shiulab/kenia/yeast_project/SHAP_Interaction/benomyl_shap_int_rf/snp_cnv/ \
	-dtype integrated_snp_cnv \
	-save shap_interaction_scores_integrated_snp_cnv_one_variant_per_gene_benomyl_500ugml

cd pav_cnv
python ${shap}/SHAP_training_saving_interaction.py \
	-df ../Features_one_variant_per_gene_benomyl_500ugml_pav_cnv.txt \
	-df2 ${data}/pheno.csv -sep , \
	-y_name YPDBENOMYL500 \
	-test ${data}/Test.txt \
	-model ../${models[6]} \
	-top 20 -interaction n -interaction_score y \
	-save integrated_one_variant_per_gene_benomyl_500ugml # forgot to add pav_cnv

echo "Summing SHAP values across isolates for integrated model"
python ${shap}/Sum_SHAP_interaction.py \
	-path /mnt/research/glbrc_group/shiulab/kenia/yeast_project/SHAP_Interaction/benomyl_shap_int_rf/pav_cnv/ \
	-dtype integrated_one_ \
	-save shap_interaction_scores_integrated_pav_cnv_one_variant_per_gene_benomyl_500ugml

conda deactivate

scontrol show job $SLURM_JOB_ID
